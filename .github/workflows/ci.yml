name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm typecheck

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm test
      - name: Run tests with coverage (FR-033)
        run: pnpm --filter @betterworld/api test -- --coverage
      - name: Verify coverage thresholds
        run: |
          echo "Coverage thresholds: guardrails>=95%, tokens>=90%, db>=85%, api>=80%, global>=75%"
          echo "Coverage enforcement is active via vitest.config coverage thresholds"

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_DB: betterworld_test
          POSTGRES_USER: betterworld
          POSTGRES_PASSWORD: betterworld_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://betterworld:betterworld_test@localhost:5432/betterworld_test
      REDIS_URL: redis://localhost:6379
      JWT_SECRET: ci-test-jwt-secret-minimum-16-chars
      NODE_ENV: test
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Install PostGIS in postgres service
        run: |
          PGCONTAINER=$(docker ps --filter "publish=5432" --format "{{.ID}}")
          docker exec "$PGCONTAINER" sh -c "apt-get update && apt-get install -y --no-install-recommends postgresql-16-postgis-3"
      - name: Setup database extensions
        run: psql "$DATABASE_URL" -f scripts/init-db.sql
      - name: Run database migrations
        run: pnpm db:migrate
      - run: pnpm test:integration

  guardrail-regression:
    name: Guardrail Regression Suite (200+ adversarial cases)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Run guardrail unit tests with coverage
        run: pnpm --filter @betterworld/guardrails test:coverage
      - name: Verify guardrail test count (>= 200 adversarial cases)
        env:
          NO_COLOR: 1
        run: |
          OUTPUT=$(pnpm --filter @betterworld/guardrails test 2>&1)
          echo "$OUTPUT" | tail -5
          CLEAN=$(printf '%s' "$OUTPUT" | sed $'s/\033\[[0-9;]*m//g')
          TEST_COUNT=$(printf '%s' "$CLEAN" | grep -E 'Tests[[:space:]]+[0-9]+ passed' | sed 's/.*Tests[[:space:]]*\([0-9][0-9]*\) passed.*/\1/')
          echo "Guardrail tests: $TEST_COUNT"
          if [ -z "$TEST_COUNT" ] || [ "$TEST_COUNT" -lt 200 ]; then
            echo "ERROR: Guardrail regression suite must have >= 200 tests (found ${TEST_COUNT:-0})"
            exit 1
          fi

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Check for high/critical vulnerabilities
        run: pnpm audit --prod --audit-level=high

  test-frontend:
    name: Frontend Tests (FR-031)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @betterworld/web test

  e2e:
    name: E2E Golden Path (FR-032)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_DB: betterworld_test
          POSTGRES_USER: betterworld
          POSTGRES_PASSWORD: betterworld_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://betterworld:betterworld_test@localhost:5432/betterworld_test
      REDIS_URL: redis://localhost:6379
      JWT_SECRET: ci-test-jwt-secret-minimum-16-chars
      NODE_ENV: test
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Install PostGIS in postgres service
        run: |
          PGCONTAINER=$(docker ps --filter "publish=5432" --format "{{.ID}}")
          docker exec "$PGCONTAINER" sh -c "apt-get update && apt-get install -y --no-install-recommends postgresql-16-postgis-3"
      - name: Setup database extensions
        run: psql "$DATABASE_URL" -f scripts/init-db.sql
      - name: Run database migrations
        run: pnpm db:migrate
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium
      - name: Run E2E golden path test
        run: pnpm exec playwright test e2e/golden-path.test.ts
      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm build
